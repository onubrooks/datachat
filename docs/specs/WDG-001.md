# WDG-001: Finance Revenue Variance Workflow v1

**Initiative ID:** `WDG-001`  
**Status:** In Progress  
**Phase:** Phase A (Finance Wedge)  
**Last Updated:** 2026-02-20

---

## 1. Problem

Finance and banking teams can query data today, but they still spend significant time validating definitions, reconciling numbers, and building decision-ready answer packs (answer + drivers + caveats + provenance).

Without a workflow-focused contract, DataChat risks becoming a broad query UI instead of a decision system for high-value finance operations.

## 2. Scope

In scope:

- Define a v1 workflow contract for finance "revenue variance and liquidity risk" investigation.
- Define output package contract for decision-grade responses.
- Define manual test plan that is executable with existing `fintech` and `grocery` demo datasets.
- Define KPI mapping and acceptance thresholds for this workflow.

Out of scope:

- New connector implementations.
- Full enterprise approvals/RBAC workflow.
- Automated anomaly remediation and action execution.

## 3. Proposed Design

### Workflow steps (v1)

1. Ask: collect business question + period + segment context.
2. Ground: resolve canonical metric definitions and ownership from DataPoints/docs.
3. Retrieve: gather SQL evidence and context evidence.
4. Verify: compute confidence, caveats, and inconsistency flags.
5. Decide: produce final answer package with drill-down path.

### Output contract (v1)

Every workflow response should include:

- `summary`: direct answer for the business question.
- `metrics`: key values used in the answer.
- `drivers`: top explanatory dimensions (for example segment/country/product drivers).
- `caveats`: assumptions, missing data, and confidence warnings.
- `sources`: table/datapoint/document provenance.
- `follow_ups`: deterministic next-step prompts.

### Architecture impact

Bounded change only (no major rewrite):

- add workflow-mode orchestration on top of existing pipeline (`ask/ground/retrieve/verify/decide` checkpoints);
- add output-packaging layer for finance workflow responses;
- add workflow-run telemetry for KPI tracking.

Existing retrieval, SQL generation, and sync infrastructure remain primary building blocks.

## 4. API and Contract Changes

Planned minimal deltas:

- [x] optional request field: `workflow_mode` (initial value: `finance_variance_v1`) for chat/ask entry points;
- [x] optional response field: `workflow_artifacts` using the output contract above;
- trace metadata should include workflow step timings and selected sources.

No breaking changes required in v1.

## 5. Data Model and Storage Changes

Planned (additive):

- workflow-run telemetry record:
  - workflow mode
  - timing per step
  - clarification count
  - confidence/caveat flags
  - source attribution coverage
- no mandatory migration for initial manual rollout; logs/telemetry store path is acceptable for v1.

## 6. Safety and Policy

- Require provenance in final output package for workflow-mode responses.
- Block "high confidence" labeling when attribution or grounding signals are missing.
- Keep current SQL safety controls and routing policy gates unchanged.
- Preserve deterministic fallback behavior for catalog/schema intents.

## 7. Acceptance Criteria

Functional:

- [ ] Workflow can be run end-to-end manually on `fintech` demo dataset.
- [x] Output package includes summary, drivers, caveats, and sources.
- [ ] Follow-up prompts can continue investigation without re-prompting context.

Quality:

- [ ] Source coverage: >= 95% of workflow answers include at least 2 explicit sources (1 data table + 1 datapoint/doc when available).
- [ ] Clarification rate: <= 0.5 clarifications per prompt on average across manual pack.
- [ ] Driver quality: top 2-3 drivers include directional impact and explain >= 70% of observed variance (or explicit caveat when unavailable).
- [ ] Consistency: when deposits/withdrawals/net flow are present, net flow arithmetic is internally consistent within <= 1% rounding tolerance.
- [ ] Reproducibility: rerunning the same prompt on unchanged data preserves summary direction and top driver set.
- [x] Quality gate script defined: `scripts/finance_workflow_gate.py` evaluates manual scorecards against release thresholds.

## 8. Test Plan

- unit:
  - workflow packaging helpers
  - caveat/confidence gating rules
- integration:
  - workflow-mode request/response schema checks
  - trace metadata completeness
- manual:
  - run `docs/finance/FINANCE_WORKFLOW_V1_MANUAL_TEST.md` on fintech and optional grocery datasets.
  - evaluate scorecard with `python scripts/finance_workflow_gate.py --scorecard <csv>`.

## 9. Rollout and Rollback

Rollout:

1. Ship workflow spec + manual test pack.
2. Implement workflow mode behind opt-in request flag.
3. Promote to default for finance persona only after KPI targets hold for one release cycle.

Rollback:

- disable workflow-mode packaging flag and continue using current standard response mode.

## 10. Open Questions

- Should workflow output packaging be UI-only first or API-first?
- Which finance persona gets default workflow mode first (FP&A vs treasury/risk)?
- What minimum confidence threshold is acceptable for leadership-facing output?
